<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Logic: Mastermind (Online)</title>
    <style>
        :root {
            --primary: #00ffcc;
            --primary-dark: #00cc99;
            --bg-dark: #0a0a0a;
            --panel-bg: rgba(20, 20, 20, 0.95); /* Thoda darker background */
            --locked: #555;
            --text-muted: #aaa;
            --error: #ff4444;
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- 3D Background (Starfield) --- */
        #starfield-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at center, #050510 0%, #000000 100%);
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.5s;
        }

        .screen.active {
            display: flex;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- LOGIN / SIGNUP SCREEN --- */
        #login-screen {
            justify-content: center;
            z-index: 10;
        }

        .login-card {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 20px;
            padding: 40px 30px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 0 40px rgba(0, 255, 204, 0.15);
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }

        .app-logo {
            font-size: 2rem;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--primary);
        }

        .auth-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .auth-tab {
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 600;
            transition: 0.3s;
            padding: 8px 16px;
            border-radius: 5px;
            background: transparent;
        }

        .auth-tab:hover {
            color: white;
            background: rgba(255,255,255,0.05);
        }

        .auth-tab.active {
            color: var(--primary);
            text-shadow: 0 0 8px var(--primary);
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid rgba(0, 255, 204, 0.2);
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .styled-input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 16px; /* Prevent zoom on mobile */
            outline: none;
            box-sizing: border-box;
            transition: 0.3s;
        }

        .styled-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
            background: rgba(0,0,0,0.8);
        }

        .action-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .action-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.4);
        }

        .error-msg {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 15px;
            min-height: 1.2em;
            display: none;
            background: rgba(255, 68, 68, 0.1);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }

        .privacy-link {
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-decoration: underline;
            cursor: pointer;
            opacity: 0.8;
        }

        .privacy-link:hover {
            color: white;
        }

        /* --- HOME HEADER --- */
        #home-header {
            width: 90%;
            max-width: 600px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 50px;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            gap: 10px;
            height: 60px;
        }

        .profile-area {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            height: 100%;
        }

        #profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--primary);
            position: relative;
        }
        
        .user-details h2 {
            margin: 0;
            font-size: 16px;
            color: white;
            white-space: nowrap;
        }

        .user-details span {
            font-size: 10px;
            color: #aaa;
        }

        .coin-badge {
            background: rgba(0,0,0,0.4);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ffd700;
            font-weight: bold;
            font-size: 0.9rem;
            border: 1px solid #ffd700;
            white-space: nowrap;
        }

        /* --- LEVEL SELECTOR --- */
        #level-select-container {
            margin-top: 30px;
            width: 90%;
            max-width: 600px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
            padding: 20px;
            background: rgba(0,0,0,0.6);
            border-radius: 20px;
            border: 1px solid #333;
            max-height: 65vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .level-btn {
            aspect-ratio: 1;
            background: var(--locked);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            color: rgba(255,255,255,0.5);
            cursor: not-allowed;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .level-btn.unlocked {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            cursor: pointer;
            border-color: #4a90e2;
        }

        .level-btn.unlocked:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,100,255,0.4);
            background: linear-gradient(135deg, #2a5298, #00ffcc);
        }

        .level-btn.completed {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .level-btn.completed::after {
            content: '‚òÖ';
            position: absolute;
            bottom: 3px;
            font-size: 10px;
            color: #ffd700;
        }

        /* --- GAME SCREEN --- */
        #game-screen {
            justify-content: center;
            background: radial-gradient(circle at center, rgba(26,26,26,0.9) 0%, rgba(0,0,0,0.95) 100%);
        }

        #game-header-bar {
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }

        .back-btn {
            pointer-events: auto;
            background: rgba(255,255,255,0.1);
            border: 1px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
            font-size: 14px;
        }

        .back-btn:hover {
            background: white;
            color: black;
        }

        .game-status {
            color: var(--primary);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 0 0 10px var(--primary);
            text-align: right;
            font-size: 14px;
        }

        #grid-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 15px;
            background: #222;
            border-radius: 12px;
            border: 2px solid #444;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            width: 90vw;
            max-width: 380px;
            aspect-ratio: 1;
        }

        .cell {
            background: #333;
            border-radius: 4px;
            border: 1px solid #555;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cell.active {
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            border-color: #fff;
        }

        /* --- WIN OVERLAY --- */
        #win-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        #win-card {
            background: #111;
            padding: 40px;
            border-radius: 20px;
            border: 2px solid var(--primary);
            text-align: center;
            box-shadow: 0 0 50px rgba(0,255,204,0.3);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        #next-level-btn {
            background: var(--primary);
            color: black;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            margin-top: 20px;
            cursor: pointer;
        }

        #next-level-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--primary);
        }

        /* --- PRIVACY MODAL --- */
        #privacy-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .privacy-content {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .privacy-content h2 { color: var(--primary); margin-top: 0; }
        .privacy-content h3 { color: white; margin-top: 20px; }
        .privacy-content p { font-size: 0.9rem; line-height: 1.5; color: #ccc; }
        
        .close-modal {
            position: absolute;
            top: 15px; right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Utility */
        .hidden { display: none !important; }
        #file-upload { display: none; }

    </style>
</head>
<body>

    <!-- 3D BACKGROUND CANVAS -->
    <canvas id="starfield-canvas"></canvas>

    <!-- PRIVACY MODAL -->
    <div class="privacy-content">
    <button class="close-modal" onclick="togglePrivacy(false)">&times;</button>
    
    <h2>Game Info & Privacy Policy</h2>
    
    <h3>About The Game</h3>
    <p><strong>Circuit Logic: Mastermind</strong> is a puzzle game inspired by "Lights Out". The goal is to turn all lights Green to restore power.</p>
    
    <h3>Privacy Policy</h3>
    <p>Your privacy is important to us. This app is designed as a safe and secure experience.</p>
    
    <ul style="padding-left: 20px; line-height: 1.6;">
        <li>
            <strong>Data Collection:</strong> We store your game progress (Coins, Levels) and Email ID in our secure Firebase database solely for the purpose of "Cloud Save" and "Cross-device Login".
        </li>
        <li style="margin-top: 10px;">
            <strong>No Third-Party Sharing:</strong> We do not sell or share your personal data with third parties.
        </li>
        <li style="margin-top: 10px;">
            <strong>Security:</strong> Passwords are encrypted and handled securely by Google Firebase Authentication.
        </li>
    </ul>

    <!-- YE NEW SECTION HAI JO INDUS KO CHAHIYE -->
    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-top: 20px;">
        <h3 style="margin-top: 0; color: #fff;">Developer Contact</h3>
        <p style="margin-bottom: 5px; color: #ccc;">If you have any questions regarding this privacy policy or the game, please contact the developer:</p>
        
        <p style="margin: 5px 0;"><strong>Developer Name:</strong>Ravi Kumar</p>
        <p style="margin: 5px 0;"><strong>Email:</strong> <a href="mailto:your.email@gmail.com" style="color: var(--primary);">raviaiagentassistant@gmail.com</a></p>
        <!-- Apna asli email upar likhna mat bhoolna -->
    </div>
    
    <p style="font-size: 0.8rem; color: #666; margin-top: 30px; text-align: center; border-top: 1px solid #333; padding-top: 10px;">
        Version 2.2 | Secure Firebase Login
    </p>
</div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="screen active">
        <div class="login-card">
            <div class="app-logo">Circuit Logic</div>
            <div style="font-size: 0.8rem; color:#888; margin-bottom: 20px;">SECURE SYSTEM ACCESS</div>

            <!-- Removed onclicks, we attach listeners in JS for reliability -->
            <div class="auth-tabs">
                <div class="auth-tab active" id="tab-login">Login</div>
                <div class="auth-tab" id="tab-signup">Sign Up</div>
            </div>

            <form id="auth-form">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" class="styled-input" id="user-email" placeholder="pilot@system.com" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" class="styled-input" id="user-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                </div>
                
                <div id="auth-error" class="error-msg">Error message here</div>
                <div id="loading-spinner" class="spinner"></div>

                <button type="submit" class="action-btn" id="auth-btn">ACCESS SYSTEM</button>
            </form>

            <div class="privacy-link" onclick="togglePrivacy(true)">Privacy Policy & Game Info</div>
        </div>
    </div>

    <!-- HOME SCREEN -->
    <div id="home-screen" class="screen">
        <div id="home-header">
            <div class="profile-area" onclick="document.getElementById('file-upload').click()">
                <div id="profile-pic" style="background-image: url('https://www.w3schools.com/howto/img_avatar.png');"></div>
                <div class="user-details">
                    <h2 id="display-name">Loading...</h2>
                    <span>ID: <span id="user-id-display">...</span></span>
                </div>
                <input type="file" id="file-upload" accept="image/*" onchange="updateProfile(event)">
            </div>
            
            <div class="coin-badge">
                <span>ü™ô</span>
                <span id="coin-count">...</span>
            </div>
        </div>

        <h1 style="margin-top: 20px; color: white; text-transform: uppercase; letter-spacing: 3px; font-size:24px; text-shadow: 0 0 10px var(--primary);">Select Sector</h1>

        <div id="level-select-container">
            <!-- Level Buttons Generated Here -->
        </div>
        
        <div style="margin-top: auto; margin-bottom: 20px; font-size: 12px; color: #666; cursor:pointer; text-decoration: underline;" onclick="logoutUser()">LOGOUT SYSTEM</div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen">
        <div id="game-header-bar">
            <button class="back-btn" onclick="goToHome()">
                <span>‚ùÆ</span> Back
            </button>
            <div class="game-status">
                LEVEL <span id="game-level-num">1</span><br>
                MOVES: <span id="game-moves">0</span>
            </div>
        </div>

        <div id="grid-board">
            <!-- Grid Cells -->
        </div>
    </div>

    <!-- WIN OVERLAY -->
    <div id="win-overlay">
        <div id="win-card">
            <h1 style="color:var(--primary); margin:0;">SYSTEM RESTORED!</h1>
            <p style="color:#aaa;">Level Complete</p>
            <h2 style="color:#ffd700;">+50 Coins</h2>
            <button id="next-level-btn" onclick="nextLevelFromWin()">Next Level >></button>
        </div>
        <canvas id="confetti-canvas" style="position:absolute; top:0; left:0; pointer-events:none;"></canvas>
    </div>

    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, auth, db, appId;
        const errorMsg = document.getElementById('auth-error');
        const authBtn = document.getElementById('auth-btn');

        // Function to show visible error
        function showError(message) {
            console.error(message);
            errorMsg.innerText = message;
            errorMsg.style.display = 'block';
        }

        // ============================================================
        // FIREBASE CONFIGURATION
        // ============================================================
        
        try {
            // OPTION 1: Automatic (Online Preview ke liye)
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                console.log("Firebase Initialized Automatically.");
            } else {
                throw new Error("Local Mode Detected");
            }
        } catch (e) {
            console.log("Auto-config failed, checking for manual config...");

            // OPTION 2: Manual (Local Computer ke liye)
            // Agar aap computer par hain, to neeche wale code ko uncomment karein (/* aur */ hatayein)
            // aur apni real values daalein:
            
            const firebaseConfig = {
               apiKey: "AIzaSyB0UcrPNJCKB0Z8A7t_df8TgdEGKLe7ZOk",
                authDomain: "doodle-2fd64.firebaseapp.com",
                projectId: "doodle-2fd64",
                storageBucket: "doodle-2fd64.firebasestorage.app",
                messagingSenderId: "950931117856",
                appId: "1:950931117856:web:fd34cf90b710f000156945",
                measurementId: "G-WP4ZZ6RV6N"
            };
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = "my-local-game";
            

            // Check if app loaded
            if(!app) {
                showError("Firebase Config Error: Agar aap local chala rahe hain, to code mein line ~570 par Manual Config uncomment karein.");
                if(authBtn) {
                    authBtn.innerText = "CONFIG MISSING";
                    authBtn.style.background = "#555";
                    authBtn.disabled = true;
                }
            }
        }
        // ============================================================


        // --- GAME STATE ---
        let state = {
            coins: 0,
            maxUnlocked: 1,
            currentLevel: 1,
            moves: 0,
            gridSize: 5,
            grid: [],
            username: "Player",
            uid: null
        };

        let isSignupMode = false;

        // --- AUTH UI LOGIC ---
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('user-email');
        const passInput = document.getElementById('user-pass');
        const spinner = document.getElementById('loading-spinner');
        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');

        function switchTab(mode) {
            isSignupMode = mode === 'signup';
            errorMsg.style.display = 'none';
            Sound.click();
            
            if(isSignupMode) {
                tabSignup.classList.add('active');
                tabLogin.classList.remove('active');
                authBtn.innerText = "CREATE ACCOUNT";
            } else {
                tabLogin.classList.add('active');
                tabSignup.classList.remove('active');
                authBtn.innerText = "ACCESS SYSTEM";
            }
        };

        // Attach listeners safely
        if(tabLogin) tabLogin.addEventListener('click', () => switchTab('login'));
        if(tabSignup) tabSignup.addEventListener('click', () => switchTab('signup'));

        // Form Submit Handler
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Attempting Auth...");
            
            if(!auth) {
                showError("Cannot connect to Auth Server. Please refresh.");
                return;
            }
            
            Sound.click();
            
            const email = emailInput.value;
            const password = passInput.value;

            setLoading(true);
            errorMsg.style.display = 'none';

            try {
                if (isSignupMode) {
                    // CREATE NEW ACCOUNT
                    console.log("Creating user...");
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log("User created:", user.uid);
                    
                    // Save initial data to Firestore
                    await saveUserData(user.uid, {
                        coins: 0,
                        maxUnlocked: 1,
                        email: email
                    });
                } else {
                    // LOGIN EXISTING
                    console.log("Signing in...");
                    await signInWithEmailAndPassword(auth, email, password);
                    console.log("Sign in successful");
                }
            } catch (error) {
                console.error("Auth Error:", error);
                let msg = "Authentication Failed: " + error.message;
                if(error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    msg = "Invalid credentials. Please check or Sign Up.";
                } else if (error.code === 'auth/email-already-in-use') {
                    msg = "Email already in use. Please Login.";
                } else if (error.code === 'auth/weak-password') {
                    msg = "Password should be at least 6 characters.";
                } else if (error.code === 'auth/network-request-failed') {
                    msg = "Network Error. Check your internet connection.";
                }
                showError(msg);
                setLoading(false);
            }
        });

        function setLoading(loading) {
            if(loading) {
                authBtn.style.display = 'none';
                spinner.style.display = 'block';
            } else {
                authBtn.style.display = 'block';
                spinner.style.display = 'none';
            }
        }

        // --- AUTH STATE LISTENER ---
        if(auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Auth State: Signed In", user.uid);
                    // User is signed in
                    state.uid = user.uid;
                    state.username = user.email ? user.email.split('@')[0] : "Player";
                    
                    // Load data from Firestore
                    await loadUserData(user.uid);

                    // Update UI
                    document.getElementById('display-name').innerText = state.username;
                    document.getElementById('user-id-display').innerText = user.uid.substring(0,6);
                    document.getElementById('coin-count').innerText = state.coins;
                    renderLevels();

                    // Switch screens
                    document.getElementById('login-screen').classList.remove('active');
                    document.getElementById('home-screen').classList.add('active');
                } else {
                    console.log("Auth State: Signed Out");
                    // User is signed out
                    document.getElementById('home-screen').classList.remove('active');
                    document.getElementById('login-screen').classList.add('active');
                    setLoading(false);
                }
            });
        }

        // --- FIRESTORE FUNCTIONS ---
        async function saveUserData(uid, data) {
            if(!db) { console.error("DB Not Initialized"); return; }
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'gameData', 'progress'), data, { merge: true });
                console.log("Data saved");
            } catch (e) {
                console.error("Error saving data: ", e);
            }
        }

        async function loadUserData(uid) {
            if(!db) { console.error("DB Not Initialized"); return; }
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', uid, 'gameData', 'progress');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.coins = data.coins || 0;
                    state.maxUnlocked = data.maxUnlocked || 1;
                } else {
                    // No data exists? Create default
                    state.coins = 0;
                    state.maxUnlocked = 1;
                }
            } catch (e) {
                console.error("Error loading data: ", e);
            }
        }

        window.logoutUser = async () => {
            if(auth) await signOut(auth);
        };

        // --- AUDIO SYSTEM ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = new AudioContext();

        function enableAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        document.addEventListener('click', enableAudio);
        document.addEventListener('touchstart', enableAudio);

        const Sound = {
            click: () => {
                if (audioCtx.state !== 'suspended') {
                    Sound.playTone(800, 100, 'sine', 0.1);
                }
            },
            playTone: (startFreq, endFreq, type, duration) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(startFreq, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(endFreq, audioCtx.currentTime + duration);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            win: () => {
                enableAudio();
                const now = audioCtx.currentTime;
                [400, 500, 600, 800].forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.05, now + i*0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.5);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(now + i*0.1);
                    osc.stop(now + i*0.1 + 0.5);
                });
            }
        };

        // --- STARFIELD ANIMATION ---
        const starCanvas = document.getElementById('starfield-canvas');
        const starCtx = starCanvas.getContext('2d');
        let stars = [];
        
        function resizeStars() {
            starCanvas.width = window.innerWidth;
            starCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeStars);
        resizeStars();

        class Star {
            constructor() {
                this.x = Math.random() * starCanvas.width - starCanvas.width/2;
                this.y = Math.random() * starCanvas.height - starCanvas.height/2;
                this.z = Math.random() * 1000;
            }
            update() {
                this.z -= 10;
                if (this.z <= 0) {
                    this.z = 1000;
                    this.x = Math.random() * starCanvas.width - starCanvas.width/2;
                    this.y = Math.random() * starCanvas.height - starCanvas.height/2;
                }
            }
            draw() {
                let x = (this.x / this.z) * 500 + starCanvas.width / 2;
                let y = (this.y / this.z) * 500 + starCanvas.height / 2;
                let size = (1000 - this.z) / 1000 * 3;
                
                if(x > 0 && x < starCanvas.width && y > 0 && y < starCanvas.height) {
                    let brightness = (1000 - this.z) / 1000;
                    starCtx.fillStyle = `rgba(200, 200, 255, ${brightness})`;
                    starCtx.beginPath();
                    starCtx.arc(x, y, size, 0, Math.PI*2);
                    starCtx.fill();
                }
            }
        }

        for(let i=0; i<500; i++) stars.push(new Star());

        function animateStars() {
            starCtx.fillStyle = 'black';
            starCtx.fillRect(0, 0, starCanvas.width, starCanvas.height);
            stars.forEach(star => {
                star.update();
                star.draw();
            });
            requestAnimationFrame(animateStars);
        }
        animateStars();


        // --- DOM ELEMENTS ---
        const homeScreen = document.getElementById('home-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelContainer = document.getElementById('level-select-container');
        const gridBoard = document.getElementById('grid-board');
        const winOverlay = document.getElementById('win-overlay');
        const privacyModal = document.getElementById('privacy-modal');

        // --- WINDOW FUNCTIONS (Exposed for HTML onclicks) ---
        window.togglePrivacy = (show) => {
            Sound.click();
            privacyModal.style.display = show ? 'flex' : 'none';
        };

        window.goToGame = (level) => {
            Sound.click();
            if (level > state.maxUnlocked) return;

            state.currentLevel = level;
            state.moves = 0;
            document.getElementById('game-level-num').innerText = level;
            document.getElementById('game-moves').innerText = '0';

            homeScreen.classList.remove('active');
            gameScreen.classList.add('active');

            generatePuzzle(level);
        };

        window.goToHome = () => {
            Sound.click();
            gameScreen.classList.remove('active');
            homeScreen.classList.add('active');
            winOverlay.style.display = 'none';
            renderLevels();
        };

        window.updateProfile = (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('profile-pic').style.backgroundImage = `url(${event.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        };
        
        window.nextLevelFromWin = () => {
            winOverlay.style.display = 'none';
            window.goToGame(state.currentLevel + 1);
        }

        // --- LEVEL SYSTEM ---
        function renderLevels() {
            levelContainer.innerHTML = '';
            for(let i=1; i<=20; i++) {
                const btn = document.createElement('div');
                btn.className = 'level-btn';
                
                if (i <= state.maxUnlocked) {
                    btn.classList.add('unlocked');
                    btn.innerText = i;
                    btn.onclick = () => window.goToGame(i);
                    
                    if(i < state.maxUnlocked) {
                        btn.classList.add('completed');
                    }
                } else {
                    btn.innerHTML = '<span style="font-size:18px">üîí</span>';
                }
                
                levelContainer.appendChild(btn);
            }
        }

        // --- GAME LOGIC ---
        function generatePuzzle(level) {
            gridBoard.innerHTML = '';
            state.grid = [];

            for(let r=0; r<state.gridSize; r++) {
                let row = [];
                for(let c=0; c<state.gridSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell active'; 
                    cell.onclick = () => handleCellClick(r, c);
                    gridBoard.appendChild(cell);
                    row.push({ el: cell, active: true });
                }
                state.grid.push(row);
            }

            let scrambleMoves = level * 3 + 5;
            for(let i=0; i<scrambleMoves; i++) {
                const r = Math.floor(Math.random() * state.gridSize);
                const c = Math.floor(Math.random() * state.gridSize);
                toggleCells(r, c, true);
            }
        }

        function toggleCells(r, c, silent=false) {
            const coords = [[0,0], [0,1], [0,-1], [1,0], [-1,0]];
            coords.forEach(([dr, dc]) => {
                const nr = r + dr;
                const nc = c + dc;
                if(nr >= 0 && nr < state.gridSize && nc >= 0 && nc < state.gridSize) {
                    const cellObj = state.grid[nr][nc];
                    cellObj.active = !cellObj.active;
                    if(cellObj.active) cellObj.el.classList.add('active');
                    else cellObj.el.classList.remove('active');
                }
            });
            if(!silent) checkWin();
        }

        function handleCellClick(r, c) {
            Sound.click();
            state.moves++;
            document.getElementById('game-moves').innerText = state.moves;
            toggleCells(r, c);
        }

        function checkWin() {
            const allActive = state.grid.every(row => row.every(cell => cell.active));
            if(allActive) {
                setTimeout(handleLevelComplete, 300);
            }
        }

        function handleLevelComplete() {
            Sound.win();
            
            // Update State
            state.coins += 50;
            if(state.currentLevel === state.maxUnlocked) {
                state.maxUnlocked++;
            }

            // Save to Firebase
            if (state.uid) {
                saveUserData(state.uid, {
                    coins: state.coins,
                    maxUnlocked: state.maxUnlocked
                });
            }

            // UI
            document.getElementById('coin-count').innerText = state.coins;
            winOverlay.style.display = 'flex';
            startConfetti();
        }

        // --- CONFETTI ---
        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            for(let i=0; i<100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    color: `hsl(${Math.random()*360}, 100%, 50%)`,
                    dy: Math.random() * 5 + 2
                });
            }

            function draw() {
                if(winOverlay.style.display === 'none') return;
                ctx.clearRect(0,0,canvas.width, canvas.height);
                particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 8, 8);
                    p.y += p.dy;
                    if(p.y > canvas.height) p.y = -10;
                });
                requestAnimationFrame(draw);
            }
            draw();
        }

    </script>
</body>
</html>
